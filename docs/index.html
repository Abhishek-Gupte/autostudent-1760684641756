<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Captcha OCR demo</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
<style>
  body { padding: 2rem; }
  .preview { max-width: 480px; border: 1px dashed #aaa; padding: 8px; }
  code { user-select: all; }
</style>
</head>
<body class="container">
  <h1 class="mb-3">Captcha Solver (Demo)</h1>
  <p class="text-muted">Pass an image via <code>?url=https://.../image.png</code>. If absent, I’ll use a safe sample.</p>

  <div class="row g-4">
    <div class="col-md-6">
      <h5>Captcha Image</h5>
      <img id="captcha-img" class="preview" alt="captcha"/>
      <div class="mt-2">
        <button id="run-ocr" class="btn btn-primary btn-sm">Solve</button>
        <span id="status" class="ms-2" aria-live="polite"></span>
      </div>
    </div>
    <div class="col-md-6">
      <h5>OCR Result (≤ 20s)</h5>
      <pre id="ocr-text" class="p-2 bg-light" style="min-height:140px; white-space:pre-wrap;"></pre>
    </div>
  </div>

  <hr/>
  <p class="small">Checks: loads ?url image and shows solved text.</p>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const statusEl = document.getElementById('status');
    const out = document.getElementById('ocr-text');
    const img = document.getElementById('captcha-img');
    img.crossOrigin = 'anonymous';

    const fallback = "https://tesseract.projectnaptha.com/img/eng_bw.png";
    const inputUrl = params.get('url') || fallback;
    if (inputUrl) img.src = inputUrl;

    function withTimeout(promise, ms) {
      return Promise.race([
        promise,
        new Promise((_, rej) => setTimeout(() => rej(new Error("Timed out")), ms))
      ]);
    }

    async function fetchAsBlob(url) {
      // Fetching then passing a Blob avoids canvas taint issues on some hosts
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error("Image fetch failed: " + res.status);
      return await res.blob();
    }

    async function runOCR(url) {
      statusEl.textContent = "Loading worker...";
      const worker = await Tesseract.createWorker();

      try {
        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');

        statusEl.textContent = "Downloading image...";
        const blob = await fetchAsBlob(url);

        statusEl.textContent = "Running OCR...";
        const result = await withTimeout(worker.recognize(blob), 20000); // 20s budget
        const text = (result?.data?.text || "").trim();
        out.textContent = text || "(no text recognized)";
        statusEl.textContent = "Done";
      } finally {
        await worker.terminate();
      }
    }

    document.getElementById('run-ocr').addEventListener('click', async () => {
      out.textContent = "";
      if (!img.src) { statusEl.textContent = "No image."; return; }
      try {
        await runOCR(img.src);
      } catch (e) {
        statusEl.textContent = "OCR failed: " + (e && e.message ? e.message : e);
      }
    });
  </script>
</body>
</html>